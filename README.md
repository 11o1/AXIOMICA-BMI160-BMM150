# AXIOMICA-BMI160-BMM150

![IMU Sensor](https://i.imgur.com/7ZkGq4l.png)

Эта библиотека предоставляет удобный интерфейс для работы с 9-осевой IMU системой, состоящей из датчиков BMI160 (акселерометр и гироскоп) и BMM150 (магнитометр). Библиотека автоматически определяет подключение датчиков и предоставляет функции для их настройки и считывания данных.

## Возможности

- Автоматическое обнаружение и инициализация датчиков
- Поддержка двух режимов подключения BMM150:
  * Прямое подключение к шине I2C (PRIMARY)
  * Подключение через вторичный интерфейс BMI160 (SECONDARY)
- Гибкая обработка частичного подключения датчиков
- Настройка диапазонов измерений акселерометра и гироскопа
- Считывание данных с заданной частотой с усреднением
- Подробная диагностика через Serial при включенной отладке
- Поддержка работы только с доступными датчиками

## Схема подключения

Для работы с этой библиотекой вам понадобятся:
- Датчик BMI160 (акселерометр + гироскоп)
- Датчик BMM150 (магнитометр)
- Arduino или совместимая плата

Подключите датчики к вашей плате следующим образом:

```
BMI160/BMM150   →   Arduino
VCC             →   3.3V
GND             →   GND
SCL             →   A5 (или соответствующий I2C SCL пин)
SDA             →   A4 (или соответствующий I2C SDA пин)
```

## Установка

1. Скачайте архив с библиотекой
2. Распакуйте содержимое в папку `libraries/IMU_BMI160_BMM150` в директории Arduino
3. Перезапустите Arduino IDE
4. Откройте пример `Universal_9Axis_Final.ino`

## Пример использования

```cpp
#include <Wire.h>
#include "IMU_BMI160_BMM150.h"

// Частота опроса данных (Гц)
#define DATA_READ_FREQUENCY 50.0f

void setup() {
    Serial.begin(115200);
    // Инициализируем IMU систему
    if (IMU_begin()) {
        Serial.println("✅ IMU инициализирована успешно");
    } else {
        Serial.println("⚠️ IMU частично инициализирована - работает только с доступными датчиками");
    }
}

void loop() {
    int16_t acc_raw[3] = {0}, gyr_raw[3] = {0}, mag_raw[3] = {0};
    int16_t rhall_raw = 0;
    
    // Считываем данные с сенсоров с заданной частотой
    IMU_readDataWithFrequency(acc_raw, gyr_raw, mag_raw, &rhall_raw, DATA_READ_FREQUENCY);
    
    // Преобразуем данные в физические единицы
    float acc_si[3] = {
        acc_raw[0] / ACC_LSB,
        acc_raw[1] / ACC_LSB,
        acc_raw[2] / ACC_LSB
    };
    
    float gyr_si[3] = {
        gyr_raw[0] / GYR_LSB,
        gyr_raw[1] / GYR_LSB,
        gyr_raw[2] / GYR_LSB
    };
    
    float mag_si[3] = {
        mag_raw[0] * MAG_LSB_UT,
        mag_raw[1] * MAG_LSB_UT,
        mag_raw[2] * MAG_LSB_UT
    };
    
    // Выводим данные в формате, удобном для анализа
    Serial.print(millis()); Serial.print("\t");
    Serial.print(acc_raw[0]); Serial.print("\t");
    // ... остальные данные
    Serial.println(String(mag_si[2], 3));
}
```

## Описание основных функций

### `bool IMU_begin()`
Инициализирует IMU систему (BMI160 + BMM150).

**Возвращает:**
- `true` - если инициализация прошла успешно
- `false` - если инициализация частичная или неудачная

**Процесс инициализации:**
1. Поиск BMI160 по адресам 0x68 и 0x69
2. Настройка параметров акселерометра и гироскопа
3. Поиск BMM150:
   - Сначала проверяются основные адреса (0x10-0x13)
   - Затем проверяется вторичный интерфейс BMI160
   - Если BMM150 не найден, выполняется полное сканирование шины I2C (0x00-0x7F)
4. Инициализация магнитометра в зависимости от обнаруженного режима

### `void IMU_readData(int16_t *acc, int16_t *gyr, int16_t *mag, int16_t *rhall)`
Считывает данные с акселерометра, гироскопа и магнитометра.

**Параметры:**
- `acc` - массив для хранения значений акселерометра (x, y, z)
- `gyr` - массив для хранения значений гироскопа (x, y, z)
- `mag` - массив для хранения значений магнитометра (x, y, z)
- `rhall` - указатель на переменную для хранения значения RHALL

**Особенности:**
- Автоматически определяет режим работы магнитометра
- Если магнитометр подключен напрямую (PRIMARY), отправляет команду Forced Mode
- Если магнитометр подключен через BMI160 (SECONDARY), управляется через BMI160

### `void IMU_readDataWithFrequency(int16_t *acc, int16_t *gyr, int16_t *mag, int16_t *rhall, float frequency)`
Читает данные сенсоров с заданной частотой, усредняя результаты.

**Параметры:**
- `acc`, `gyr`, `mag`, `rhall` - как в IMU_readData
- `frequency` - частота опроса в Гц

**Особенности:**
- Устанавливает максимальную частоту измерений для всех датчиков
- Считывает данные с максимально возможной частотой
- Усредняет данные для достижения заданной частоты
- Всегда возвращает последние прочитанные данные, даже если новые данные недоступны
- Если заданная частота выше максимальной, используется максимальная

### `void IMU_setAccelRange(uint8_t range)`
Устанавливает диапазон измерений акселерометра.

**Диапазоны:**
- `0x03`: ±2g (16384 LSB/g)
- `0x05`: ±4g (8192 LSB/g)
- `0x08`: ±8g (4096 LSB/g)
- `0x0C`: ±16g (2048 LSB/g)

### `void IMU_setGyroRange(uint8_t range)`
Устанавливает диапазон измерений гироскопа.

**Диапазоны:**
- `0x00`: ±2000°/s (16.384 LSB/°/s)
- `0x01`: ±1000°/s (32.768 LSB/°/s)
- `0x02`: ±500°/s (65.536 LSB/°/s)
- `0x03`: ±250°/s (131.072 LSB/°/s)
- `0x04`: ±125°/s (262.144 LSB/°/s)

### `MagMode IMU_getMagMode()`
Возвращает текущий режим работы магнитометра.

**Возможные значения:**
- `NONE`: магнитометр не обнаружен
- `PRIMARY`: BMM150 подключен напрямую к шине I2C
- `SECONDARY`: BMM150 подключен через вторичный интерфейс BMI160

### `bool IMU_isInitialized()`
Проверяет статус инициализации системы.

**Возвращает:**
- `true` - если система успешно инициализирована
- `false` - в противном случае

## Глобальные переменные

- `ACC_LSB` - коэффициент преобразования для акселерометра (LSB/g)
- `GYR_LSB` - коэффициент преобразования для гироскопа (LSB/°/s)
- `MAG_LSB_UT` - коэффициент преобразования для магнитометра (LSB/μT), по умолчанию 0.3

## Настройка

Для включения отладочного вывода добавьте в начало вашего скетча:

```cpp
#define IMU_BMI160_BMM150_DEBUG
```

Это включит подробный вывод лога инициализации и работы датчиков в Serial монитор.

## Формат вывода данных

Пример вывода из `Universal_9Axis_Final.ino`:

```
24	0	0	0	0	0	0	-49	96	184	26909	0.000	0.000	0.000	0.000	0.000	0.000	-14.700	28.800	55.200
```

Структура вывода:
1. Время (мс)
2. Данные акселерометра (сырые значения) - 3 столбца
3. Данные гироскопа (сырые значения) - 3 столбца
4. Данные магнитометра (сырые значения) - 3 столбца
5. Значение RHALL
6. Данные акселерометра в физических единицах (g) - 3 столбца
7. Данные гироскопа в физических единицах (°/s) - 3 столбца
8. Данные магнитометра в физических единицах (μT) - 3 столбца

## Известные проблемы

**Проблема с нулевыми значениями:**
Если вы наблюдаете периодические нулевые значения при использовании функции `IMU_readDataWithFrequency`, убедитесь, что вы используете последнюю версию библиотеки. В более ранних версиях функция могла возвращать нули, если не прошло достаточно времени для следующего чтения данных.

**Решение:**
В последней версии библиотеки функция `IMU_readDataWithFrequency` всегда возвращает последние прочитанные данные, даже если новые данные недоступны, что предотвращает появление нулевых значений в потоке данных.

## Поддержка

Если у вас возникли вопросы или проблемы с библиотекой, пожалуйста, создайте issue на GitHub.

## Авторы

- Bosch Sensortec (оригинальная документация)
- Axiomica (адаптация и улучшения)